// Generated by CoffeeScript 1.7.1
define(['jquery', 'me', 'utils', 'js/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML', 'ehbs!templates/questions/question.edit', 'ehbs!templates/questions/questions.index', 'ehbs!templates/questions/questions.new'], function($, me, utils) {
  var QuestionsRoute;
  QuestionsRoute = {
    setup: function(App) {
      App.Router.map(function() {
        this.resource('questions', function() {
          return this.route('new');
        });
        return this.resource('question', {
          path: '/question/:question_id'
        }, function() {
          return this.route('edit');
        });
      });
      App.QuestionsRoute = Ember.Route.extend({
        beforeModel: function() {
          var thiz;
          thiz = this;
          return me.auth.check().then(function(user) {
            if (user == null) {
              return thiz.transitionTo('login');
            }
          }, function(errors) {
            this.fail;
            return thiz.transitionTo('login');
          });
        }
      });
      App.QuestionRoute = Ember.Route.extend({
        beforeModel: function() {
          var thiz;
          thiz = this;
          return me.auth.check().then(function(user) {
            if (user == null) {
              return thiz.transitionTo('login');
            }
          }, function(errors) {
            this.fail;
            return thiz.transitionTo('login');
          });
        }
      });
      App.QuestionEditRoute = Ember.Route.extend({
        model: function() {
          var qid, thiz;
          thiz = this;
          qid = this.modelFor('question').id;
          return new Ember.RSVP.Promise(function(resolve, reject) {
            return new Ember.RSVP.hash({
              question_real: thiz.store.find('question', qid),
              question_fake: thiz.store.createRecord('question', {}),
              schools: thiz.store.find('school')
            }).then(function(result) {
              return resolve({
                question_real: result.question_real,
                question_fake: result.question_fake,
                schools: result.schools
              });
            }, function(errors) {
              return reject(errors);
            });
          });
        },
        afterModel: function(model, transition) {
          var c, course, fake, real, s, school, subject, t, term, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2;
          real = model.question_real;
          fake = model.question_fake;
          fake.set('school', real.get('school'));
          school = fake.get('school').toJSON();
          real.eachAttribute(function(name, meta) {
            return fake.set(name, real.get(name));
          });
          fake.set('initialize', {
            subject: true,
            term: true,
            course: true
          });
          subject = school.info.subjects[0];
          _ref = school.info.subjects;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            s = _ref[_i];
            if (s.code === real.get('subject')) {
              subject = s;
              break;
            }
          }
          fake.set('subject', subject);
          term = subject.terms[0];
          _ref1 = subject.terms;
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            t = _ref1[_j];
            if (t.name === real.get('term')) {
              term = t;
              break;
            }
          }
          fake.set('term', term);
          course = term.courses[0];
          _ref2 = term.courses;
          for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
            c = _ref2[_k];
            if (c.number === real.get('course')) {
              course = c;
              break;
            }
          }
          return fake.set('course', course);
        }
      });
      App.QuestionEditView = Ember.View.extend({
        didInsertElement: function() {
          var hintEditor, questionEditor, solutionEditor, summaryEditor;
          this._super();
          questionEditor = utils.createMathEditor($('#question-input'), $('#question-preview'));
          hintEditor = utils.createMathEditor($('#hint-input'), $('#hint-preview'));
          solutionEditor = utils.createMathEditor($('#solution-input'), $('#solution-preview'));
          summaryEditor = utils.createMathEditor($('#summary-input'), $('#summary-preview'));
          questionEditor.update();
          hintEditor.update();
          solutionEditor.update();
          return summaryEditor.update();
        }
      });
      App.QuestionEditController = Ember.ObjectController.extend({
        difficulties: [1, 2, 3, 4, 5],
        subjects: (function() {
          var school;
          school = this.get('question_fake.school');
          if (school == null) {
            return [];
          }
          if (this.get('question_fake.initialize.subject')) {
            this.set('question_fake.initialize.subject', false);
          } else {
            this.set('question_fake.subject', school.toJSON().info.subjects[0]);
          }
          return school.toJSON().info.subjects;
        }).property('question_fake.school'),
        terms: (function() {
          var subject;
          subject = this.get('question_fake.subject');
          if (subject == null) {
            return [];
          }
          if (this.get('question_fake.initialize.term')) {
            this.set('question_fake.initialize.term', false);
          } else {
            this.set('question_fake.term', subject.terms[0]);
          }
          return subject.terms;
        }).property('question_fake.subject'),
        courses: (function() {
          var term;
          term = this.get('question_fake.term');
          if (term == null) {
            return [];
          }
          if (this.get('question_fake.initialize.course')) {
            this.set('question_fake.initialize.course', false);
          } else {
            this.set('question_fake.course', term.courses[0]);
          }
          return term.courses;
        }).property('question_fake.term'),
        prepare: function(question) {
          var another;
          another = question.toJSON();
          another.subject = question.get('subject.code');
          another.term = question.get('term.name');
          another.course = question.get('course.number');
          another.question = $('#question-input').html();
          another.hint = $('#hint-input').html();
          another.solution = $('#solution-input').html();
          another.summary = $('#summary-input').html();
          if (question.get('difficulty') == null) {
            another.difficulty = 0;
          }
          another = this.store.createRecord('Question', another);
          return another.set('school', question.get('school'));
        },
        actions: {
          save: function() {
            var question, question_fake, result, thiz;
            thiz = this;
            question_fake = this.prepare(this.get('question_fake'));
            result = question_fake.validate();
            this.set('question_fake.errors', question_fake.errors);
            if (!result) {
              return false;
            }
            question = this.get('question_real');
            question.eachAttribute(function(name, meta) {
              return question.set(name, question_fake.get(name));
            });
            question.save().then(function() {
              return thiz.transitionToRoute('questions');
            }, function(errors) {
              question.rollback;
              console.log(errors);
              return alert(errors);
            });
            return false;
          }
        }
      });
      App.QuestionsIndexRoute = Ember.Route.extend({
        model: function() {
          return this.store.find('question');
        }
      });
      App.QuestionsIndexController = Ember.ArrayController.extend({
        preview: {},
        itemController: 'questionItem'
      });
      App.QuestionItemController = Ember.ObjectController.extend({
        needs: 'questionsIndex',
        actions: {
          "delete": function(question) {
            var ans;
            ans = confirm('Do you want to delete question ' + question.id + '?');
            if (ans) {
              question.destroyRecord().then(function() {
                return true;
              }, function(errors) {
                question.rollback();
                return alert(errors.responseText);
              });
            }
            return false;
          },
          view: function(question) {
            var hintView, questionView, solutionView, summaryView;
            this.set('controllers.questionsIndex.preview', question);
            question = question.toJSON();
            questionView = $('#question-view').html(question.question);
            hintView = $('#hint-view').html(question.hint);
            solutionView = $('#solution-view').html(question.solution);
            summaryView = $('#summary-view').html(question.summary);
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, $('#modal-math')[0]]);
            $('.modal').modal();
            return false;
          }
        }
      });
      App.QuestionsNewRoute = Ember.Route.extend({
        model: function() {
          var thiz;
          thiz = this;
          return new Ember.RSVP.Promise(function(resolve, reject) {
            return new Ember.RSVP.hash({
              question: thiz.store.createRecord('question', {}),
              schools: thiz.store.find('school')
            }).then(function(result) {
              return resolve({
                question: result.question,
                schools: result.schools
              });
            }, function(errors) {
              return reject(errors);
            });
          });
        }
      });
      App.QuestionsNewView = Ember.View.extend({
        didInsertElement: function() {
          var hintEditor, questionEditor, solutionEditor, summaryEditor;
          this._super();
          questionEditor = utils.createMathEditor($('#question-input'), $('#question-preview'));
          hintEditor = utils.createMathEditor($('#hint-input'), $('#hint-preview'));
          solutionEditor = utils.createMathEditor($('#solution-input'), $('#solution-preview'));
          return summaryEditor = utils.createMathEditor($('#summary-input'), $('#summary-preview'));
        }
      });
      return App.QuestionsNewController = Ember.ObjectController.extend({
        difficulties: [1, 2, 3, 4, 5],
        subjects: (function() {
          var school;
          school = this.get('question.school');
          if (school == null) {
            return [];
          }
          this.set('question.subject', school.toJSON().info.subjects[0]);
          return school.toJSON().info.subjects;
        }).property('question.school'),
        terms: (function() {
          var subject;
          subject = this.get('question.subject');
          if (subject == null) {
            return [];
          }
          this.set('question.term', subject.terms[0]);
          return subject.terms;
        }).property('question.subject'),
        courses: (function() {
          var term;
          term = this.get('question.term');
          if (term == null) {
            return [];
          }
          this.set('question.course', term.courses[0]);
          return term.courses;
        }).property('question.term'),
        prepare: function(question) {
          var another;
          another = question.toJSON();
          another.subject = question.get('subject.code');
          another.term = question.get('term.name');
          another.course = question.get('course.number');
          another.question = $('#question-input').html();
          another.hint = $('#hint-input').html();
          another.solution = $('#solution-input').html();
          another.summary = $('#summary-input').html();
          if (question.get('difficulty') == null) {
            another.difficulty = 0;
          }
          another = this.store.createRecord('Question', another);
          another.set('school', question.get('school'));
          return another;
        },
        actions: {
          add: function() {
            var question, result, thiz;
            thiz = this;
            question = this.prepare(this.get('question'));
            result = question.validate();
            this.set('question.errors', question.errors);
            if (!result) {
              return false;
            }
            question.save().then(function() {
              return thiz.transitionToRoute('questions');
            }, function(errors) {
              question.rollback();
              console.log(errors);
              return alert(errors);
            });
            return false;
          }
        }
      });
    }
  };
  return QuestionsRoute;
});
