define(["jquery","me","utils","components/photo-upload","moment","js/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML","ehbs!templates/questions/question.index","ehbs!templates/questions/question.edit","ehbs!templates/questions/questions.index","ehbs!templates/questions/questions.new"],function(t,e,i,s){var n;return n={setup:function(n){return n.Router.map(function(){return this.resource("questions",function(){return this.route("new")}),this.resource("question",{path:"/question/:question_id"},function(){return this.route("edit")})}),n.PhotoUploadComponent=s,n.QuestionsRoute=Ember.Route.extend({beforeModel:function(){var t;return t=this,e.auth.check().then(function(e){return null==e?t.transitionTo("login"):void 0},function(){return this.fail,t.transitionTo("login")})}}),n.QuestionRoute=Ember.Route.extend({beforeModel:function(){var t;return t=this,e.auth.check().then(function(e){return null==e?t.transitionTo("login"):void 0},function(){return this.fail,t.transitionTo("login")})}}),n.QuestionEditRoute=Ember.Route.extend({model:function(){var t,e;return e=this,t=this.modelFor("question").id,new Ember.RSVP.Promise(function(i,s){return new Ember.RSVP.hash({question_real:e.store.find("question",t),question_fake:e.store.createRecord("question",{}),schools:e.store.find("school")}).then(function(t){return i({question_real:t.question_real,question_fake:t.question_fake,schools:t.schools})},function(t){return s(t)})})},afterModel:function(t){var e,i,s,n,o,r,u,l,c,a,h,m,f,d,g,p,q,b;for(n=t.question_real,s=t.question_fake,s.set("school",n.get("school")),r=s.get("school").toJSON(),n.eachAttribute(function(t){return s.set(t,n.get(t))}),s.set("id",n.get("id")),s.set("initialize",{subject:!0,term:!0,course:!0}),c=r.info.terms[0],p=r.info.terms,a=0,f=p.length;f>a;a++)if(l=p[a],l.name===n.get("term")){c=l;break}for(s.set("term",c),u=c.subjects[0],q=c.subjects,h=0,d=q.length;d>h;h++)if(o=q[h],o.name===n.get("subject")){u=o;break}for(s.set("subject",u),i=u.courses[0],b=u.courses,m=0,g=b.length;g>m;m++)if(e=b[m],e.number===n.get("course")){i=e;break}return s.set("course",i)}}),n.QuestionEditView=Ember.View.extend({didInsertElement:function(){var e,s,n,o;return this._super(),s=i.createMathEditor(t("#question-input"),t("#question-preview")),e=i.createMathEditor(t("#hint-input"),t("#hint-preview")),n=i.createMathEditor(t("#solution-input"),t("#solution-preview")),o=i.createMathEditor(t("#summary-input"),t("#summary-preview")),s.update(),e.update(),n.update(),o.update()}}),n.QuestionEditController=Ember.ObjectController.extend({uploadLink:"/api/images/temp",types:["other","quiz","assignment","midterm","final","textbook"],difficulties:[1,2,3,4,5],terms:function(){var t;return t=this.get("question_fake.school"),null==t?[]:(this.get("question_fake.initialize.term")?this.set("question_fake.initialize.term",!1):this.set("question_fake.term",t.toJSON().info.terms[0]),t.toJSON().info.terms)}.property("question_fake.school"),subjects:function(){var t;return t=this.get("question_fake.term"),null==t?[]:(this.get("question_fake.initialize.subject")?this.set("question_fake.initialize.subject",!1):this.set("question_fake.subject",t.subjects[0]),t.subjects)}.property("question_fake.term"),courses:function(){var t;return t=this.get("question_fake.subject"),null==t?[]:(this.get("question_fake.initialize.course")?this.set("question_fake.initialize.course",!1):this.set("question_fake.course",t.courses[0]),t.courses)}.property("question_fake.subject"),prepare:function(e){var i;return i=e.toJSON(),i.subject=e.get("subject.name"),i.term=e.get("term.name"),i.course=e.get("course.number"),i.question=t("#question-input").html(),i.hint=t("#hint-input").html(),i.solution=t("#solution-input").html(),i.summary=t("#summary-input").html(),null==e.get("difficulty")&&(i.difficulty=0),i=this.store.createRecord("Question",i),i.set("school",e.get("school"))},actions:{save:function(){var t,i,s,n,o,r,u,l;for(r=this,n=this.prepare(this.get("question_fake")),o=n.validate(),this.set("question_fake.errors",n.errors),i=e.keys(n.errors),u=0,l=i.length;l>u;u++)t=i[u],alert(n.errors[t]);return o?(s=this.get("question_real"),s.eachAttribute(function(t){return s.set(t,n.get(t))}),s.save().then(function(){return r.transitionToRoute("questions")},function(t){return s.rollback,console.log(t),alert(t.responseText)}),!1):!1}}}),n.QuestionIndexRoute=Ember.Route.extend({model:function(){var t;return t=this.modelFor("question").id,this.store.find("question",t)}}),n.QuestionIndexView=Ember.View.extend({didInsertElement:function(){var e;return this._super(),e=this.controller.get("model").toJSON(),t("#question-preview").html(e.question),t("#hint-preview").html(e.hint),t("#solution-preview").html(e.solution),t("#summary-preview").html(e.summary),MathJax.Hub.Queue(["Typeset",MathJax.Hub,t(".question-form .right")[0]])}}),n.QuestionIndexController=Ember.ObjectController.extend({actions:{back:function(){return window.history.go(-1),!1}}}),n.QuestionsIndexRoute=Ember.Route.extend({model:function(){return this.store.find("question")}}),n.QuestionsIndexController=Ember.ArrayController.extend({sortProperties:["id"],sortAscending:!1,preview:{},itemController:"questionItem"}),n.QuestionItemController=Ember.ObjectController.extend({isHidden:function(){return this.get("flag")>0?!1:!0}.property("flag"),needs:"questionsIndex",actions:{"delete":function(t){var e,i;return i=t.get("school.name")+" "+t.get("term")+" "+t.get("subject")+" "+t.get("course"),e=confirm("Do you want to delete question "+t.get("id")+" of "+i+"?"),e&&(t.set("flag",0),t.save().then(function(){return!0},function(e){return t.rollback(),alert(e.responseText)})),!1}}}),n.QuestionsNewRoute=Ember.Route.extend({model:function(){var t;return t=this,new Ember.RSVP.Promise(function(e,i){return new Ember.RSVP.hash({question:t.store.createRecord("question",{}),schools:t.store.find("school")}).then(function(t){return e({question:t.question,schools:t.schools})},function(t){return i(t)})})},afterModel:function(){return this.controllerFor("questionsNew").set("initialize",{school:!0})}}),n.QuestionsNewView=Ember.View.extend({didInsertElement:function(){var e,s,n,o;return this._super(),s=i.createMathEditor(t("#question-input"),t("#question-preview")),e=i.createMathEditor(t("#hint-input"),t("#hint-preview")),n=i.createMathEditor(t("#solution-input"),t("#solution-preview")),o=i.createMathEditor(t("#summary-input"),t("#summary-preview"))}}),n.QuestionsNewController=Ember.ObjectController.extend({initialize:null,needs:"application",types:["other","quiz","assignment","midterm","final","textbook"],difficulties:[1,2,3,4,5],uploadLink:"/api/images/temp",settings:function(){var e,i;return e=t.cookie("settings"),null==e?null:(i=JSON.parse(e),i[this.get("controllers.application.model._id")])}.property("initialize"),terms:function(){var t,e,i;return e=this.get("question.school"),null==e?(this.set("question.term",null),[]):(e.toJSON().info.terms.length>0?this.get("initialize.term")&&this.get("settings")?(i=this.get("settings"),t=e.toJSON().info.terms.find(function(t){return t.name===i.term?!0:!1}),null!=t&&(this.set("question.term",t),this.set("initialize.subject",!0)),this.set("initialize.term",!1)):this.set("question.term",e.toJSON().info.terms[0]):this.set("question.term",null),e.toJSON().info.terms)}.property("question.school"),subjects:function(){var t,e,i;return i=this.get("question.term"),null==i?(this.set("question.subject",null),[]):(null!=i.subjects&&i.subjects.length>0?this.get("initialize.subject")&&this.get("settings")?(e=this.get("settings"),t=i.subjects.find(function(t){return t.name===e.subject?!0:!1}),null!=t&&(this.set("question.subject",t),this.set("initialize.course",!0)),this.set("initialize.subject",!1)):this.set("question.subject",i.subjects[0]):this.set("question.subject",null),i.subjects)}.property("question.term"),courses:function(){var t,e,i;return i=this.get("question.subject"),null==i?(this.set("question.course",null),[]):(null!=i.courses&&i.courses.length>0?this.get("initialize.course")&&this.get("settings")?(e=this.get("settings"),t=i.courses.find(function(t){return t.number===e.course?!0:!1}),null!=t&&(this.set("question.course",t),t=this.get("types").find(function(t){return t===e.type?!0:!1}),null!=t&&this.set("question.type",t)),this.set("initialize.course",!1)):this.set("question.course",i.courses[0]):this.set("question.course",null),i.courses)}.property("question.subject"),schoolsChanged:function(){var t,e;return this.get("initialize.school")&&this.get("settings")?(e=this.get("settings"),t=this.get("schools").find(function(t){return t.get("name")===e.school?!0:!1}),null!=t&&(this.set("question.school",t),this.set("initialize.term",!0)),this.set("initialize.school",!1)):void 0}.observes("schools"),prepare:function(e){var i;return i=e.toJSON(),i.term=e.get("term.name"),i.subject=e.get("subject.name"),i.course=e.get("course.number"),i.question=t("#question-input").html(),i.hint=t("#hint-input").html(),i.solution=t("#solution-input").html(),i.summary=t("#summary-input").html(),null==e.get("difficulty")&&(i.difficulty=0),i=this.store.createRecord("Question",i),i.set("school",e.get("school")),i},saveSettings:function(){var e,i,s;return s=this.get("controllers.application.model._id"),e={school:this.get("question.school.name"),term:this.get("question.term.name"),subject:this.get("question.subject.name"),course:this.get("question.course.number"),type:this.get("question.type")},i=t.cookie("settings"),i=null==i?{}:JSON.parse(i),i[s]=e,t.cookie("settings",JSON.stringify(i),{expires:7})},actions:{add:function(){var t,i,s,n,o,r,u;for(o=this,s=this.prepare(this.get("question")),n=s.validate(),this.set("question.errors",s.errors),i=e.keys(s.errors),r=0,u=i.length;u>r;r++)t=i[r],alert(s.errors[t]);return n?(s.save().then(function(){return o.saveSettings(),o.transitionToRoute("questions")},function(t){return s.rollback(),console.log(t),alert(t.responseText)}),!1):!1}}})}}});