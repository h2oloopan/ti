// Generated by CoffeeScript 1.7.1
define(['jquery', 'me', 'utils', 'js/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML', 'ehbs!templates/questions/question.edit', 'ehbs!templates/questions/questions.index', 'ehbs!templates/questions/questions.new'], function($, me, utils) {
  var QuestionsRoute;
  QuestionsRoute = {
    setup: function(App) {
      App.Router.map(function() {
        this.resource('questions', function() {
          return this.route('new');
        });
        return this.resource('question', {
          path: '/question/:question_id'
        }, function() {
          return this.route('edit');
        });
      });
      App.QuestionsRoute = Ember.Route.extend({
        beforeModel: function() {
          var thiz;
          thiz = this;
          return me.auth.check().then(function(user) {
            if (user == null) {
              return thiz.transitionTo('login');
            }
          }, function(errors) {
            this.fail;
            return thiz.transitionTo('login');
          });
        }
      });
      App.QuestionRoute = Ember.Route.extend({
        beforeModel: function() {
          var thiz;
          thiz = this;
          return me.auth.check().then(function(user) {
            if (user == null) {
              return thiz.transitionTo('login');
            }
          }, function(errors) {
            this.fail;
            return thiz.transitionTo('login');
          });
        }
      });
      App.QuestionEditRoute = Ember.Route.extend({
        model: function() {
          var qid, thiz;
          thiz = this;
          qid = this.modelFor('question').id;
          return new Ember.RSVP.Promise(function(resolve, reject) {
            return new Ember.RSVP.hash({
              question: thiz.store.find('question', qid),
              schools: thiz.store.find('school')
            }).then(function(result) {
              return resolve({
                question: result.question,
                schools: result.schools
              });
            }, function(errors) {
              return reject(errors);
            });
          });
        }
      });
      App.QuestionEditView = Ember.View.extend({
        didInsertElement: function() {
          var Preview;
          this._super();
          Preview = this.controller.get('Preview');
          Preview.init();
          Preview.callback = MathJax.Callback(['createPreview', Preview]);
          Preview.callback.autoReset = true;
          Preview.update();
          return $('#math-input').keyup(function() {
            return Preview.update();
          });
        }
      });
      App.QuestionEditController = Ember.ObjectController.extend({
        actions: {
          save: function() {
            var question, result, thiz;
            thiz = this;
            question = this.get('question');
            result = question.validate();
            if (!result) {
              return false;
            }
            question.save().then(function() {
              return thiz.transitionToRoute('questions');
            }, function(errors) {
              console.log(errors);
              return alert(errors);
            });
            return false;
          }
        }
      });
      App.QuestionsIndexRoute = Ember.Route.extend({
        model: function() {
          return this.store.find('question');
        }
      });
      App.QuestionsIndexController = Ember.ArrayController.extend({
        preview: {},
        itemController: 'questionItem'
      });
      App.QuestionItemController = Ember.ObjectController.extend({
        needs: 'questionsIndex',
        actions: {
          "delete": function(question) {
            var ans;
            ans = confirm('Do you want to delete question ' + question.id + '?');
            if (ans) {
              question.destroyRecord().then(function() {
                return true;
              }, function(errors) {
                question.rollback();
                return alert(errors.responseText);
              });
            }
            return false;
          },
          view: function(question) {
            var math;
            this.set('controllers.questionsIndex.preview', question);
            math = document.getElementById('modal-math');
            math.innerHTML = question.get('question');
            MathJax.Hub.Queue(['Typeset', MathJax.Hub, math]);
            $('.modal').modal();
            return false;
          }
        }
      });
      App.QuestionsNewRoute = Ember.Route.extend({
        model: function() {
          var thiz;
          thiz = this;
          return new Ember.RSVP.Promise(function(resolve, reject) {
            return new Ember.RSVP.hash({
              question: thiz.store.createRecord('question', {}),
              schools: thiz.store.find('school')
            }).then(function(result) {
              return resolve({
                question: result.question,
                schools: result.schools
              });
            }, function(errors) {
              return reject(errors);
            });
          });
        }
      });
      App.QuestionsNewView = Ember.View.extend({
        didInsertElement: function() {
          var hintEditor, questionEditor, solutionEditor, summaryEditor;
          this._super();
          questionEditor = utils.createMathEditor($('#question-input'), $('#question-preview'));
          hintEditor = utils.createMathEditor($('#hint-input'), $('#hint-preview'));
          solutionEditor = utils.createMathEditor($('#solution-input'), $('#solution-preview'));
          return summaryEditor = utils.createMathEditor($('#summary-input'), $('#summary-preview'));
        }
      });
      return App.QuestionsNewController = Ember.ObjectController.extend({
        difficulties: [1, 2, 3, 4, 5],
        subjects: (function() {
          var school;
          school = this.get('question.school');
          if (school == null) {
            return [];
          }
          this.set('question.subject', school.toJSON().info.subjects[0]);
          return school.toJSON().info.subjects;
        }).property('question.school'),
        terms: (function() {
          var subject;
          subject = this.get('question.subject');
          if (subject == null) {
            return [];
          }
          this.set('question.term', subject.terms[0]);
          return subject.terms;
        }).property('question.subject'),
        courses: (function() {
          var term;
          term = this.get('question.term');
          if (term == null) {
            return [];
          }
          this.set('question.course', term.courses[0]);
          return term.courses;
        }).property('question.term'),
        prepare: function(question) {
          var another;
          another = question.toJSON();
          another.subject = question.get('subject.code');
          another.term = question.get('term.name');
          another.course = question.get('course.number');
          another.question = $('#question-input').html();
          another.hint = $('#hint-input').html();
          another.solution = $('#solution-input').html();
          another.summary = $('#summary-input').html();
          another = this.store.createRecord('Question', another);
          another.set('school', question.get('school'));
          return another;
        },
        actions: {
          add: function() {
            var question, result, thiz;
            thiz = this;
            question = this.prepare(this.get('question'));
            console.log(question);
            result = question.validate();
            this.set('question.errors', question.errors);
            if (!result) {
              return false;
            }
            question.save().then(function() {
              return thiz.transitionToRoute('questions');
            }, function(errors) {
              console.log(errors);
              return alert(errors);
            });
            return false;
          }
        }
      });
    }
  };
  return QuestionsRoute;
});
