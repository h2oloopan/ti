define(["jquery","me","utils","components/photo-upload","moment","js/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML","ehbs!templates/questions/question.index","ehbs!templates/questions/question.edit","ehbs!templates/questions/questions.index","ehbs!templates/questions/questions.new"],function(e,t,n,s){var i;return i={setup:function(i){return Ember.Handlebars.registerBoundHelper("display-time",function(e,t){return moment(t).format(e)}),i.Router.map(function(){return this.resource("questions",function(){return this.route("new")}),this.resource("question",{path:"/question/:question_id"},function(){return this.route("edit")})}),i.PhotoUploadComponent=s,i.QuestionsRoute=Ember.Route.extend({beforeModel:function(){var e;return e=this,t.auth.check().then(function(t){return null==t?e.transitionTo("login"):void 0},function(){return this.fail,e.transitionTo("login")})}}),i.QuestionRoute=Ember.Route.extend({beforeModel:function(){var e;return e=this,t.auth.check().then(function(t){return null==t?e.transitionTo("login"):void 0},function(){return this.fail,e.transitionTo("login")})}}),i.QuestionEditRoute=Ember.Route.extend({model:function(){var e,t;return t=this,e=this.modelFor("question").id,new Ember.RSVP.Promise(function(n,s){return new Ember.RSVP.hash({question_real:t.store.find("question",e),question_fake:t.store.createRecord("question",{}),schools:t.store.find("school")}).then(function(e){return n({question_real:e.question_real,question_fake:e.question_fake,schools:e.schools})},function(e){return s(e)})})},afterModel:function(e){var t,n,s,i,o,r,u,l,c,a,h,f,m,d,p,g,q,b;for(i=e.question_real,s=e.question_fake,s.set("school",i.get("school")),r=s.get("school").toJSON(),i.eachAttribute(function(e){return s.set(e,i.get(e))}),s.set("id",i.get("id")),s.set("initialize",{subject:!0,term:!0,course:!0}),c=r.info.terms[0],g=r.info.terms,a=0,m=g.length;m>a;a++)if(l=g[a],l.name===i.get("term")){c=l;break}for(s.set("term",c),u=c.subjects[0],q=c.subjects,h=0,d=q.length;d>h;h++)if(o=q[h],o.name===i.get("subject")){u=o;break}for(s.set("subject",u),n=u.courses[0],b=u.courses,f=0,p=b.length;p>f;f++)if(t=b[f],t.number===i.get("course")){n=t;break}return s.set("course",n)}}),i.QuestionEditView=Ember.View.extend({didInsertElement:function(){var t,s,i,o;return this._super(),s=n.createMathEditor(e("#question-input"),e("#question-preview")),t=n.createMathEditor(e("#hint-input"),e("#hint-preview")),i=n.createMathEditor(e("#solution-input"),e("#solution-preview")),o=n.createMathEditor(e("#summary-input"),e("#summary-preview")),s.update(),t.update(),i.update(),o.update()}}),i.QuestionEditController=Ember.ObjectController.extend({uploadLink:"/api/images/temp",types:["other","quiz","assignment","midterm","final","textbook"],difficulties:[1,2,3,4,5],terms:function(){var e;return e=this.get("question_fake.school"),null==e?[]:(this.get("question_fake.initialize.term")?this.set("question_fake.initialize.term",!1):this.set("question_fake.term",e.toJSON().info.terms[0]),e.toJSON().info.terms)}.property("question_fake.school"),subjects:function(){var e;return e=this.get("question_fake.term"),null==e?[]:(this.get("question_fake.initialize.subject")?this.set("question_fake.initialize.subject",!1):this.set("question_fake.subject",e.subjects[0]),e.subjects)}.property("question_fake.term"),courses:function(){var e;return e=this.get("question_fake.subject"),null==e?[]:(this.get("question_fake.initialize.course")?this.set("question_fake.initialize.course",!1):this.set("question_fake.course",e.courses[0]),e.courses)}.property("question_fake.subject"),prepare:function(t){var n;return n=t.toJSON(),n.subject=t.get("subject.name"),n.term=t.get("term.name"),n.course=t.get("course.number"),n.question=e("#question-input").html(),n.hint=e("#hint-input").html(),n.solution=e("#solution-input").html(),n.summary=e("#summary-input").html(),null==t.get("difficulty")&&(n.difficulty=0),n=this.store.createRecord("Question",n),n.set("school",t.get("school"))},actions:{save:function(){var e,n,s,i,o,r,u,l;for(r=this,i=this.prepare(this.get("question_fake")),o=i.validate(),this.set("question_fake.errors",i.errors),n=t.keys(i.errors),u=0,l=n.length;l>u;u++)e=n[u],alert(i.errors[e]);return o?(s=this.get("question_real"),s.eachAttribute(function(e){return s.set(e,i.get(e))}),s.save().then(function(){return r.transitionToRoute("questions")},function(e){return s.rollback,console.log(e),alert(e.responseText)}),!1):!1}}}),i.QuestionIndexRoute=Ember.Route.extend({model:function(){var e;return e=this.modelFor("question").id,this.store.find("question",e)}}),i.QuestionIndexView=Ember.View.extend({didInsertElement:function(){var t;return this._super(),t=this.controller.get("model").toJSON(),e("#question-preview").html(t.question),e("#hint-preview").html(t.hint),e("#solution-preview").html(t.solution),e("#summary-preview").html(t.summary),MathJax.Hub.Queue(["Typeset",MathJax.Hub,e(".question-form .right")[0]])}}),i.QuestionIndexController=Ember.ObjectController.extend({actions:{back:function(){return window.history.go(-1),!1}}}),i.QuestionsIndexRoute=Ember.Route.extend({model:function(){return this.store.find("question")}}),i.QuestionsIndexController=Ember.ArrayController.extend({sortProperties:["id"],sortAscending:!1,preview:{},itemController:"questionItem"}),i.QuestionItemController=Ember.ObjectController.extend({isHidden:function(){return this.get("flag")>0?!1:!0}.property("flag"),needs:"questionsIndex",actions:{"delete":function(e){var t,n;return n=e.get("school.name")+" "+e.get("term")+" "+e.get("subject")+" "+e.get("course"),t=confirm("Do you want to delete question "+e.get("id")+" of "+n+"?"),t&&(e.set("flag",0),e.save().then(function(){return!0},function(t){return e.rollback(),alert(t.responseText)})),!1}}}),i.QuestionsNewRoute=Ember.Route.extend({model:function(){var e;return e=this,new Ember.RSVP.Promise(function(t,n){return new Ember.RSVP.hash({question:e.store.createRecord("question",{}),schools:e.store.find("school")}).then(function(e){return t({question:e.question,schools:e.schools})},function(e){return n(e)})})},afterModel:function(){return this.controllerFor("questionsNew").set("initialize",{school:!0})}}),i.QuestionsNewView=Ember.View.extend({didInsertElement:function(){var t,s,i,o;return this._super(),s=n.createMathEditor(e("#question-input"),e("#question-preview")),t=n.createMathEditor(e("#hint-input"),e("#hint-preview")),i=n.createMathEditor(e("#solution-input"),e("#solution-preview")),o=n.createMathEditor(e("#summary-input"),e("#summary-preview"))}}),i.QuestionsNewController=Ember.ObjectController.extend({initialize:null,needs:"application",types:["other","quiz","assignment","midterm","final","textbook","wechat"],difficulties:[1,2,3,4,5],uploadLink:"/api/images/temp",settings:function(){var t,n;return t=e.cookie("settings"),null==t?null:(n=JSON.parse(t),n[this.get("controllers.application.model._id")])}.property("initialize"),terms:function(){var e;return e=this.get("question.school"),null==e?[]:e.toJSON().terms}.property("question.school"),subjects:function(){var e,t,n;return t=this.get("question.school"),null==t?(this.set("question.subject",null),[]):(t.toJSON().info.subjects.length>0?this.get("initialize.subject")&&this.get("settings")?(n=this.get("settings"),e=t.toJSON().info.subjects.find(function(e){return e.name===n.subject?!0:!1}),null!=e&&(this.set("question.subject",e),this.set("initialize.course",!0)),this.set("initialize.subject",!1)):this.set("question.subject",t.toJSON().info.subjects[0]):this.set("question.subject",null),t.toJSON().info.subjects)}.property("question.term"),courses:function(){var e,t,n;return n=this.get("question.subject"),null==n?(this.set("question.course",null),[]):(null!=n.courses&&n.courses.length>0?this.get("initialize.course")&&this.get("settings")?(t=this.get("settings"),e=n.courses.find(function(e){return e.number===t.course?!0:!1}),null!=e&&(this.set("question.course",e),e=this.get("types").find(function(e){return e===t.type?!0:!1}),null!=e&&this.set("question.type",e)),this.set("initialize.course",!1)):this.set("question.course",n.courses[0]):this.set("question.course",null),n.courses)}.property("question.subject"),schoolsChanged:function(){var e,t;return this.get("initialize.school")&&this.get("settings")?(t=this.get("settings"),e=this.get("schools").find(function(e){return e.get("name")===t.school?!0:!1}),null!=e&&(this.set("question.school",e),this.set("initialize.subject",!0)),this.set("initialize.school",!1)):void 0}.observes("schools"),prepare:function(t){var n;return n=t.toJSON(),n.term=t.get("term.name"),n.subject=t.get("subject.name"),n.course=t.get("course.number"),n.question=e("#question-input").html(),n.hint=e("#hint-input").html(),n.solution=e("#solution-input").html(),n.summary=e("#summary-input").html(),null==t.get("difficulty")&&(n.difficulty=0),n=this.store.createRecord("Question",n),n.set("school",t.get("school")),n},saveSettings:function(){var t,n,s;return s=this.get("controllers.application.model._id"),t={school:this.get("question.school.name"),subject:this.get("question.subject.name"),course:this.get("question.course.number"),type:this.get("question.type")},n=e.cookie("settings"),n=null==n?{}:JSON.parse(n),n[s]=t,e.cookie("settings",JSON.stringify(n),{expires:7})},actions:{add:function(){var e,n,s,i,o,r,u;for(o=this,s=this.prepare(this.get("question")),i=s.validate(),this.set("question.errors",s.errors),n=t.keys(s.errors),r=0,u=n.length;u>r;r++)e=n[r],alert(s.errors[e]);return i?(s.save().then(function(){return o.saveSettings(),o.transitionToRoute("questions")},function(e){return s.rollback(),console.log(e),alert(e.responseText)}),!1):!1}}})}}});