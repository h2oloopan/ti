// Generated by CoffeeScript 1.7.1
define(['jquery', 'me', 'utils', 'components/photo-upload', 'moment', 'infinite', 'js/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML', 'bootstrap-tagsinput', 'ehbs!templates/questions/question.index', 'ehbs!templates/questions/question.edit', 'ehbs!templates/questions/questions.index', 'ehbs!templates/questions/questions.select', 'ehbs!templates/questions/questions.new', 'ehbs!templates/helpers/pager'], function($, me, utils, PhotoUploadComponent, mmt) {
  var QuestionsRoute;
  QuestionsRoute = {
    setup: function(App) {
      Ember.Handlebars.registerBoundHelper('display-time', function(format, time) {
        return moment(time).format(format);
      });
      App.Router.map(function() {
        this.resource('questions', function() {
          this.route('new');
          return this.route('select');
        });
        return this.resource('question', {
          path: '/question/:question_id'
        }, function() {
          return this.route('edit');
        });
      });
      App.PhotoUploadComponent = PhotoUploadComponent;
      App.QuestionsRoute = Ember.Route.extend({
        beforeModel: function() {
          var thiz;
          thiz = this;
          return me.auth.check().then(function(user) {
            if (user == null) {
              return thiz.transitionTo('login');
            }
          }, function(errors) {
            this.fail;
            return thiz.transitionTo('login');
          });
        }
      });
      App.QuestionRoute = Ember.Route.extend({
        beforeModel: function() {
          var thiz;
          thiz = this;
          return me.auth.check().then(function(user) {
            if (user == null) {
              return thiz.transitionTo('login');
            }
          }, function(errors) {
            this.fail;
            return thiz.transitionTo('login');
          });
        }
      });
      App.QuestionEditRoute = Ember.Route.extend({
        model: function() {
          var qid, thiz;
          thiz = this;
          qid = this.modelFor('question').id;
          return new Ember.RSVP.Promise(function(resolve, reject) {
            return new Ember.RSVP.hash({
              question_real: thiz.store.find('question', qid),
              question_fake: thiz.store.createRecord('question', {}),
              schools: thiz.store.find('school')
            }).then(function(result) {
              return resolve({
                question_real: result.question_real,
                question_fake: result.question_fake,
                schools: result.schools
              });
            }, function(errors) {
              return reject(errors);
            });
          });
        },
        afterModel: function(model, transition) {
          var c, course, fake, real, s, school, subject, _i, _j, _len, _len1, _ref, _ref1;
          real = model.question_real;
          fake = model.question_fake;
          fake.set('school', real.get('school'));
          school = fake.get('school').toJSON();
          real.eachAttribute(function(name, meta) {
            return fake.set(name, real.get(name));
          });
          fake.set('id', real.get('id'));
          fake.set('initialize', {
            subject: true,
            course: true
          });
          subject = school.info.subjects[0];
          _ref = school.info.subjects;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            s = _ref[_i];
            if (s.name === real.get('subject')) {
              subject = s;
              break;
            }
          }
          fake.set('subject', subject);
          course = subject.courses[0];
          _ref1 = subject.courses;
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            c = _ref1[_j];
            if (c.number === real.get('course')) {
              course = c;
              break;
            }
          }
          return fake.set('course', course);
        }
      });
      App.QuestionEditView = Ember.View.extend({
        didInsertElement: function() {
          var hintEditor, questionEditor, solutionEditor, summaryEditor;
          this._super();
          $('#type-tags').tagsinput();
          $('#tags').tagsinput();
          questionEditor = utils.createMathEditor($('#question-input'), $('#question-preview'));
          hintEditor = utils.createMathEditor($('#hint-input'), $('#hint-preview'));
          solutionEditor = utils.createMathEditor($('#solution-input'), $('#solution-preview'));
          summaryEditor = utils.createMathEditor($('#summary-input'), $('#summary-preview'));
          questionEditor.update();
          hintEditor.update();
          solutionEditor.update();
          return summaryEditor.update();
        }
      });
      App.QuestionEditController = Ember.ObjectController.extend({
        uploadLink: '/api/images/temp',
        difficulties: [1, 2, 3, 4, 5],
        terms: (function() {
          var school;
          school = this.get('question_fake.school');
          if (school == null) {
            return [];
          }
          if (school.toJSON().terms.length > 0) {
            this.set('selectedTerm', school.toJSON().terms[0]);
          }
          return school.toJSON().terms;
        }).property('question_fake.school'),
        types: (function() {
          var school;
          school = this.get('question_fake.school');
          if (school == null) {
            return [];
          }
          if (school.toJSON().types.length > 0) {
            this.set('selectedType', school.toJSON().types[0]);
          }
          return school.toJSON().types;
        }).property('question_fake.school'),
        subjects: (function() {
          var school;
          school = this.get('question_fake.school');
          if (school == null) {
            return [];
          }
          if (this.get('question_fake.initialize.subject')) {
            this.set('question_fake.initialize.subject', false);
          } else {
            this.set('question_fake.subject', school.info.subjects[0]);
          }
          return school.toJSON().info.subjects;
        }).property('question_fake.school'),
        courses: (function() {
          var subject;
          subject = this.get('question_fake.subject');
          if (subject == null) {
            return [];
          }
          if (this.get('question_fake.initialize.course')) {
            this.set('question_fake.initialize.course', false);
          } else {
            this.set('question_fake.course', subject.courses[0]);
          }
          return subject.courses;
        }).property('question_fake.subject'),
        prepare: function(question) {
          var another;
          another = question.toJSON();
          another.subject = question.get('subject.name');
          another.course = question.get('course.number');
          another.question = $('#question-input').cleanHtml();
          another.hint = $('#hint-input').cleanHtml();
          another.solution = $('#solution-input').cleanHtml();
          another.summary = $('#summary-input').cleanHtml();
          another.typeTags = $('#type-tags').val().replace(/, /g, ',').replace(/,/g, ', ');
          another.tags = $('#tags').val().replace(/, /g, ',').replace(/,/g, ', ');
          if (question.get('difficulty') == null) {
            another.difficulty = 0;
          }
          another = this.store.createRecord('Question', another);
          return another.set('school', question.get('school'));
        },
        actions: {
          addTypeTag: function() {
            var tag, term, type;
            term = this.get('selectedTerm');
            type = this.get('selectedType');
            tag = term + ' ' + type;
            $('#type-tags').tagsinput('add', tag);
            return false;
          },
          save: function() {
            var key, keys, question, question_fake, result, thiz, _i, _len;
            thiz = this;
            question_fake = this.prepare(this.get('question_fake'));
            result = question_fake.validate();
            this.set('question_fake.errors', question_fake.errors);
            keys = me.keys(question_fake.errors);
            for (_i = 0, _len = keys.length; _i < _len; _i++) {
              key = keys[_i];
              alert(question_fake.errors[key]);
            }
            if (!result) {
              return false;
            }
            question = this.get('question_real');
            question.eachAttribute(function(name, meta) {
              return question.set(name, question_fake.get(name));
            });
            question.save().then(function() {
              return thiz.transitionToRoute('questions');
            }, function(errors) {
              question.rollback;
              console.log(errors);
              return alert(errors.responseText);
            });
            return false;
          }
        }
      });
      App.QuestionIndexRoute = Ember.Route.extend({
        model: function() {
          var qid;
          qid = this.modelFor('question').id;
          return this.store.find('question', qid);
        }
      });
      App.QuestionIndexView = Ember.View.extend({
        didInsertElement: function() {
          var question;
          this._super();
          question = this.controller.get('model').toJSON();
          $('#question-preview').html(question.question);
          $('#hint-preview').html(question.hint);
          $('#solution-preview').html(question.solution);
          $('#summary-preview').html(question.summary);
          return MathJax.Hub.Queue(['Typeset', MathJax.Hub, $('.question-form .right')[0]]);
        }
      });
      App.QuestionIndexController = Ember.ObjectController.extend({
        actions: {
          back: function() {
            window.history.go(-1);
            return false;
          }
        }
      });
      App.QuestionsIndexRoute = Ember.Route.extend({
        model: function() {
          return this.store.find('question', {
            advanced: JSON.stringify({
              skip: 0,
              limit: 50,
              order: '-'
            })
          });
        }
      });
      App.QuestionsIndexController = Ember.ArrayController.extend({
        sortProperties: ['id'],
        sortAscending: false,
        preview: {},
        itemController: 'questionItem'
      });
      App.QuestionItemController = Ember.ObjectController.extend({
        isHidden: (function() {
          if (this.get('flag') > 0) {
            return false;
          }
          return true;
        }).property('flag'),
        needs: 'questionsIndex',
        actions: {
          "delete": function(question) {
            var ans, name;
            name = question.get('school.name') + ' ' + question.get('term') + ' ' + question.get('subject') + ' ' + question.get('course');
            ans = confirm('Do you want to delete question ' + question.get('id') + ' of ' + name + '?');
            if (ans) {
              question.set('flag', 0);
              question.save().then(function() {
                return true;
              }, function(errors) {
                question.rollback();
                return alert(errors.responseText);
              });
            }
            return false;
          }
        }
      });
      App.QuestionsSelectRoute = Ember.Route.extend({
        model: function() {
          var thiz;
          thiz = this;
          return new Ember.RSVP.Promise(function(resolve, reject) {
            return new Ember.RSVP.hash({
              schools: thiz.store.find('school')
            }).then(function(result) {
              return resolve({
                schools: result.schools,
                questions: []
              });
            }, function(errors) {
              return reject(errors);
            });
          });
        }
      });
      App.QuestionsSelectView = Ember.View.extend(InfiniteScroll.ViewMixin, {
        didInsertElement: function() {
          this._super();
          this.setupInfiniteScrollListener();
          return $('#type-tags').tagsinput();
        },
        willDestroyElement: function() {
          this._super();
          return this.teardownInfiniteScrollListener();
        }
      });
      App.QuestionsSelectController = Ember.ObjectController.extend(InfiniteScroll.ControllerMixin, {
        sortProperties: ['id'],
        sortAscending: false,
        perPage: 10,
        page: 0,
        hasMore: false,
        advanced: {},
        subjects: (function() {
          var school, subjects;
          school = this.get('school');
          if (school == null) {
            return [];
          }
          subjects = school.get('info.subjects');
          if (subjects.length > 0) {
            this.set('subject', subjects[0]);
          }
          return subjects;
        }).property('school'),
        courses: (function() {
          var courses, subject;
          subject = this.get('subject');
          if (subject == null) {
            return [];
          }
          courses = subject.courses;
          if (courses.length > 0) {
            this.set('course', courses[0]);
          }
          return courses;
        }).property('subject'),
        terms: (function() {
          var school, terms;
          school = this.get('school');
          if (school == null) {
            return [];
          }
          terms = school.get('terms');
          if (terms.length > 0) {
            this.set('term', terms[0]);
          }
          return terms;
        }).property('school'),
        types: (function() {
          var school, types;
          school = this.get('school');
          if (school == null) {
            return [];
          }
          types = school.get('types');
          if (types.length > 0) {
            this.set('type', types[0]);
          }
          return types;
        }).property('school'),
        total: (function() {
          return this.store.metadataFor('question').total;
        }).property('model.questions'),
        actions: {
          addTypeTag: function() {
            var tag, term, type;
            term = this.get('term');
            type = this.get('type');
            tag = term + ' ' + type;
            $('#type-tags').tagsinput('add', tag);
            return false;
          },
          next: function() {
            var advanced;
            advanced = this.get('advanced');
            advanced.skip += advanced.limit;
            if (advanced.skip >= total) {
              this.set('hasMore', false);
              return false;
            }
            this.send('update', advanced);
            return false;
          },
          getMore: function() {
            var next, page, per;
            page = this.get('page');
            per = this.get('perPage');
            next = page + 1;
            this.set('page', next);
            this.send('fetchPage', next, per);
            return false;
          },
          fetchPage: function(page, perPage) {
            var advanced, questions, thiz;
            thiz = this;
            questions = this.get('questions');
            advanced = this.get('advanced');
            advanced.limit = perPage;
            advanced.skip = (page - 1) * perPage;
            return this.store.find('question', {
              advanced: JSON.stringify(advanced)
            }).then(function(result) {
              var total;
              questions = thiz.get('questions');
              questions.pushObjects(result.content);
              thiz.set('questions', questions);
              total = thiz.get('total');
              if (page * perPage >= total) {
                thiz.set('hasMore', false);
              }
              return true;
            }, function(errors) {
              alert(errors.responseText);
              return false;
            });
          },
          search: function() {
            var advanced;
            this.set('questions', []);
            this.set('page', 0);
            advanced = {
              school: this.get('school.id'),
              subject: this.get('subject.name'),
              course: this.get('course.number'),
              types: $('#type-tags').tagsinput('items')
            };
            this.set('hasMore', true);
            this.set('advanced', advanced);
            this.send('getMore');
            return false;
          },
          generate: function() {
            var counter, course, json, jump, question, questions, questionsA, questionsB, questionsC, school, schoolName, subject, testA, testB, testC, thiz, title, _i, _len;
            thiz = this;
            school = this.get('school');
            schoolName = this.get('school.name');
            subject = this.get('subject.name');
            course = this.get('course.number');
            questions = this.get('questions');
            title = schoolName + ' ' + subject + ' ' + course;
            questionsA = [];
            questionsB = [];
            questionsC = [];
            for (_i = 0, _len = questions.length; _i < _len; _i++) {
              question = questions[_i];
              json = question.toJSON();
              json._id = question.get('id');
              if (question.inA) {
                questionsA.push(json);
              }
              if (question.inB) {
                questionsB.push(json);
              }
              if (question.inC) {
                questionsC.push(json);
              }
            }
            counter = 0;
            if (questionsA.length > 0) {
              testA = this.store.createRecord('test', {});
              testA.set('name', title + ' A');
              testA.set('school', school);
              testA.set('subject', subject);
              testA.set('course', course);
              testA.set('questions', questionsA);
              counter++;
            }
            if (questionsB.length > 0) {
              testB = this.store.createRecord('test', {});
              testB.set('name', title + ' B');
              testB.set('school', school);
              testB.set('subject', subject);
              testB.set('course', course);
              testB.set('questions', questionsB);
              counter++;
            }
            if (questionsC.length > 0) {
              testC = this.store.createRecord('test', {});
              testC.set('name', title + ' C');
              testC.set('school', school);
              testC.set('subject', subject);
              testC.set('course', course);
              testC.set('questions', questionsC);
              counter++;
            }
            jump = function() {
              var query, tests;
              tests = [];
              if (testA != null) {
                tests.push(testA.get('id'));
              }
              if (testB != null) {
                tests.push(testB.get('id'));
              }
              if (testC != null) {
                tests.push(testC.get('id'));
              }
              query = JSON.stringify(tests);
              return thiz.transitionToRoute('tests.review', {
                queryParams: {
                  tests: query
                }
              });
            };
            if (testA != null) {
              testA.save().then(function(result) {
                testA = result;
                counter--;
                if (counter === 0) {
                  jump();
                }
                return true;
              }, function(errors) {
                testA = null;
                counter--;
                if (counter === 0) {
                  jump();
                }
                return false;
              });
            }
            if ((testB != null) > 0) {
              testB.save().then(function(result) {
                testB = result;
                counter--;
                if (counter === 0) {
                  jump();
                }
                return true;
              }, function(errors) {
                testB = null;
                counter--;
                if (counter === 0) {
                  jump();
                }
                return false;
              });
            }
            if ((testC != null) > 0) {
              testC.save().then(function(result) {
                testC = result;
                counter--;
                if (counter === 0) {
                  jump();
                }
                return true;
              }, function(errors) {
                testC = null;
                counter--;
                if (counter === 0) {
                  jump();
                }
                return false;
              });
            }
            return false;
          }
        }
      });
      App.QuestionSelectItemView = Ember.View.extend({
        isHidden: (function() {
          if (this.get('flag') > 0) {
            return false;
          }
          return true;
        }).property('flag'),
        didInsertElement: function() {
          var element;
          this._super();
          element = this.get('element');
          return MathJax.Hub.Queue(['Typeset', MathJax.Hub, element]);
        }
      });
      App.QuestionsNewRoute = Ember.Route.extend({
        model: function() {
          var thiz;
          thiz = this;
          return new Ember.RSVP.Promise(function(resolve, reject) {
            return new Ember.RSVP.hash({
              question: thiz.store.createRecord('question', {}),
              schools: thiz.store.find('school')
            }).then(function(result) {
              return resolve({
                question: result.question,
                schools: result.schools
              });
            }, function(errors) {
              return reject(errors);
            });
          });
        },
        afterModel: function(model, transition) {
          return this.controllerFor('questionsNew').set('initialize', {
            school: true
          });
        }
      });
      App.QuestionsNewView = Ember.View.extend({
        didInsertElement: function() {
          var hintEditor, questionEditor, solutionEditor, summaryEditor;
          this._super();
          $('#type-tags').tagsinput();
          $('#tags').tagsinput();
          questionEditor = utils.createMathEditor($('#question-input'), $('#question-preview'), {
            check: true,
            url: '/api/search/questions/text',
            display: $('#question-display')
          });
          hintEditor = utils.createMathEditor($('#hint-input'), $('#hint-preview'));
          solutionEditor = utils.createMathEditor($('#solution-input'), $('#solution-preview'));
          return summaryEditor = utils.createMathEditor($('#summary-input'), $('#summary-preview'));
        }
      });
      return App.QuestionsNewController = Ember.ObjectController.extend({
        initialize: null,
        needs: 'application',
        difficulties: [1, 2, 3, 4, 5],
        uploadLink: '/api/images/temp',
        settings: (function() {
          var cookie, data;
          cookie = $.cookie('settings');
          if (cookie == null) {
            return null;
          }
          data = JSON.parse(cookie);
          return data[this.get('controllers.application.model._id')];
        }).property('initialize'),
        terms: (function() {
          var school;
          school = this.get('question.school');
          if (school == null) {
            return [];
          }
          if (school.toJSON().terms.length > 0) {
            this.set('selectedTerm', school.toJSON().terms[0]);
          }
          return school.toJSON().terms;
        }).property('question.school'),
        types: (function() {
          var school;
          school = this.get('question.school');
          if (school == null) {
            return [];
          }
          if (school.toJSON().types.length > 0) {
            this.set('selectedType', school.toJSON().types[0]);
          }
          return school.toJSON().types;
        }).property('question.school'),
        subjects: (function() {
          var found, school, settings;
          school = this.get('question.school');
          if (school == null) {
            this.set('question.subject', null);
            return [];
          }
          if (school.toJSON().info.subjects.length > 0) {
            if (this.get('initialize.subject') && this.get('settings')) {
              settings = this.get('settings');
              found = school.toJSON().info.subjects.find(function(item) {
                if (item.name === settings.subject) {
                  return true;
                }
                return false;
              });
              if (found != null) {
                this.set('question.subject', found);
                this.set('initialize.course', true);
              }
              this.set('initialize.subject', false);
            } else {
              this.set('question.subject', school.toJSON().info.subjects[0]);
            }
          } else {
            this.set('question.subject', null);
          }
          return school.toJSON().info.subjects;
        }).property('question.school'),
        courses: (function() {
          var found, settings, subject;
          subject = this.get('question.subject');
          if (subject == null) {
            this.set('question.course', null);
            return [];
          }
          if ((subject.courses != null) && subject.courses.length > 0) {
            if (this.get('initialize.course') && this.get('settings')) {
              settings = this.get('settings');
              found = subject.courses.find(function(item) {
                if (item.number === settings.course) {
                  return true;
                }
                return false;
              });
              if (found != null) {
                this.set('question.course', found);
              }
              this.set('initialize.course', false);
            } else {
              this.set('question.course', subject.courses[0]);
            }
          } else {
            this.set('question.course', null);
          }
          return subject.courses;
        }).property('question.subject'),
        schoolsChanged: (function() {
          var found, settings;
          if (this.get('initialize.school') && this.get('settings')) {
            settings = this.get('settings');
            found = this.get('schools').find(function(item) {
              if (item.get('name') === settings.school) {
                return true;
              }
              return false;
            });
            if (found != null) {
              this.set('question.school', found);
              this.set('initialize.subject', true);
            }
            return this.set('initialize.school', false);
          }
        }).observes('schools'),
        prepare: function(question) {
          var another;
          another = question.toJSON();
          another.subject = question.get('subject.name');
          another.course = question.get('course.number');
          another.question = $('#question-input').cleanHtml();
          another.hint = $('#hint-input').cleanHtml();
          another.solution = $('#solution-input').cleanHtml();
          another.summary = $('#summary-input').cleanHtml();
          another.typeTags = $('#type-tags').val().replace(',', ', ');
          another.tags = $('#tags').val().replace(',', ', ');
          if (question.get('difficulty') == null) {
            another.difficulty = 0;
          }
          another = this.store.createRecord('Question', another);
          another.set('school', question.get('school'));
          return another;
        },
        saveSettings: function() {
          var settings, storage, uid;
          uid = this.get('controllers.application.model._id');
          settings = {
            school: this.get('question.school.name'),
            subject: this.get('question.subject.name'),
            course: this.get('question.course.number')
          };
          storage = $.cookie('settings');
          if (storage == null) {
            storage = {};
          } else {
            storage = JSON.parse(storage);
          }
          storage[uid] = settings;
          return $.cookie('settings', JSON.stringify(storage), {
            expires: 7
          });
        },
        actions: {
          addTypeTag: function() {
            var tag, term, type;
            term = this.get('selectedTerm');
            type = this.get('selectedType');
            tag = term + ' ' + type;
            $('#type-tags').tagsinput('add', tag);
            return false;
          },
          add: function() {
            var key, keys, question, result, thiz, _i, _len;
            thiz = this;
            question = this.prepare(this.get('question'));
            result = question.validate();
            this.set('question.errors', question.errors);
            keys = me.keys(question.errors);
            for (_i = 0, _len = keys.length; _i < _len; _i++) {
              key = keys[_i];
              alert(question.errors[key]);
            }
            if (!result) {
              return false;
            }
            question.save().then(function() {
              thiz.saveSettings();
              return thiz.transitionToRoute('questions');
            }, function(errors) {
              question.rollback();
              console.log(errors);
              return alert(errors.responseText);
            });
            return false;
          }
        }
      });
    }
  };
  return QuestionsRoute;
});
