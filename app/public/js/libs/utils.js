// Generated by CoffeeScript 1.7.1
define(['jquery', 'bootstrap-wysiwyg'], function($) {
  var utils;
  return utils = {
    createMathEditor: function(input, preview, options) {
      var MathEditor;
      MathEditor = (function() {
        function MathEditor(input, preview, options) {
          this.input = input;
          this.preview = preview;
          this.options = options;
          this.init();
        }

        MathEditor.prototype.delay = 300;

        MathEditor.prototype.timeout = null;

        MathEditor.prototype.running = false;

        MathEditor.prototype.checking = false;

        MathEditor.prototype.init = function() {
          var check, checking, counter, display, match, minimum, step, thiz, url;
          thiz = this;
          $(this.input).wysiwyg();
          $(this.input).on('keypress', function() {
            return thiz.update();
          });
          $(this.input).on('paste', function(e) {
            var content;
            e.preventDefault();
            if (e.originalEvent.clipboardData) {
              content = (e.originalEvent || e).clipboardData.getData('text/plain');
              return document.execCommand('insertText', false, content);
            } else if (window.clipboardData) {
              content = window.clipboardData.getData('Text');
              return document.selection.createRange().pasteHTML(content);
            }
          });
          this.options = this.options || {};
          check = this.options.check || false;
          url = this.options.url || null;
          display = this.options.display || null;
          if (check && (url != null) && (display != null)) {
            minimum = this.options.minimum || 30;
            step = this.options.step || 10;
            counter = 0;
            match = true;
            checking = false;
            thiz = this;
            return $(this.input).keydown(function(e) {
              var address, text;
              if (counter < minimum) {
                return counter++;
              }
              if (!match) {
                return;
              }
              if (checking) {
                return;
              }
              text = $(thiz.input).cleanHtml();
              address = url + '?text=' + text;
              checking = true;
              return $.get(address).done(function(ids) {
                var id, message, _i, _len;
                if (ids.length === 0) {
                  match = false;
                } else {
                  message = 'Possible duplication(s): ';
                  for (_i = 0, _len = ids.length; _i < _len; _i++) {
                    id = ids[_i];
                    message += '<a target="_blank" href="/#/question/' + id + '/edit">' + id + '</a>';
                  }
                  $(display).html(message);
                  $(display).show();
                }
                checking = false;
                minimum += step;
                return true;
              }).fail(function(errors) {
                checking = false;
                minimum += step;
                return false;
              });
            });
          }
        };

        MathEditor.prototype.update = function() {
          var thiz;
          thiz = this;
          if (this.timeout) {
            clearTimeout(this.timeout);
          }
          return this.timeout = setTimeout(function() {
            var content;
            if (thiz.running) {
              return;
            }
            content = $(thiz.input).html();
            $(thiz.preview).html(content);
            thiz.running = true;
            return MathJax.Hub.Queue(['Typeset', MathJax.Hub, $(thiz.preview)[0]], ['done', thiz]);
          }, this.delay);
        };

        MathEditor.prototype.done = function() {
          return this.running = false;
        };

        return MathEditor;

      })();
      return new MathEditor(input, preview, options);
    }
  };
});
