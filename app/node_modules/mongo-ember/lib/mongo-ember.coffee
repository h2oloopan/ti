path = require 'path'
fs = require 'fs'

mongoose = require 'mongoose'
mongo = require './mongo'
js = require './js'
api = require './api'
auth = require './auth'
optimizer = require './optimizer'

settings = exports.settings = {}
definitions = {}
getModelDefinition = exports.getModelDefinition = (name) ->
	return definitions[name]

me = module.exports = 
	Schema: mongoose.Schema
	encrypt: (str) ->
		return auth.encrypt str
	getModel: (name) ->
		return mongoose.models[name]
	getSchema: (name) ->
		return mongo.getSchema name
	createModel: (name, schema, validationMessages) ->
		model = mongo.createModel name, schema
		js.addModel model, validationMessages
	loadModels: (folder) ->
		load = (dir) ->
			files = fs.readdirSync dir
			for file in files
				do (file) ->
					file = path.join dir, file
					if !fs.statSync(file).isDirectory()
						if path.extname(file) == settings.modelExtension
							obj = require file
							name = Object.keys(obj)[0]
							schema = obj[name].schema
							definitions[name] = obj[name]
							validationMessages = obj[name].validationMessages
							me.createModel name, schema, validationMessages
					else
						#it's directory
						load file
		load folder
	connect: (connectionString, cb) ->
		mongoose.connect connectionString,
			server:
				socketOptions:
					keepAlive: 1

		mongoose.connection.on 'connected', ->
			console.log 'MongoDB connected'
			if cb? then cb()

		mongoose.connection.on 'disconnected', ->
			console.log 'MongoDB disconnected'

		mongoose.connection.on 'error', (err) ->
			console.log 'MongoDB returned with error ' + err

	setup: (options) ->
		settings.modelExtension = options.modelExtension || '.js'
		settings.modelsFolder = options.modelsFolder || null
		settings.namespace = options.namespace || null
		settings.connectionString = options.connectionString || null
		settings.primaryKey = options.primaryKey || '_id'
		settings.mePath = options.mePath || '/js/me.js'
		settings.meOutputPath = options.meOutputPath || null
		settings.debug = options.debug || true
		settings.userModel = options.userModel || 'User'
		settings.usernameField = options.usernameField || 'username'
		settings.passwordField = options.passwordField || 'password'
		settings.authPath = options.authPath || '/api/auth'
		settings.sessionKey = options.sessionKey || 'me'
		settings.powerField = options.powerField || 'power'
		settings.defaultPower = options.defaultPower || 0 #here we assume power is an integer and the larger the number is, the more privilege a user possesses

		settings.optimize = options.optimize || null

		@loadModels settings.modelsFolder
		return @
	init: (app, cb) ->
		app.use auth.middleware
		app.use api.middleware
		js.bind app
		api.bind app
		auth.bind app

		if settings.optimize? 
			optimizer.optimize settings.optimize
		
		if settings.connectionString? then @connect settings.connectionString, cb

	

