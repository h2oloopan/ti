// Generated by CoffeeScript 1.6.3
var api, crud, h, me, mongoose, utils;

mongoose = require('mongoose');

utils = require('mongoose/lib/utils');

me = require('./mongo-ember');

h = require('./helper');

crud = function(app, url, name) {
  var apiFunctions, authFunctions, cname, dummyAuthFunction, manipulateFunctions, model, pf;
  model = mongoose.models[name];
  cname = utils.toCollectionName(name);
  pf = me.settings.powerField;
  authFunctions = me.getModelDefinition(name).auth;
  apiFunctions = me.getModelDefinition(name).api;
  manipulateFunctions = me.getModelDefinition(name).manipulate;
  if (authFunctions == null) {
    authFunctions = {};
  }
  if (apiFunctions == null) {
    apiFunctions = {};
  }
  if (manipulateFunctions == null) {
    manipulateFunctions = {};
  }
  dummyAuthFunction = function(req, user, power, cb) {
    return cb(null);
  };
  app.post(url, function(req, res) {
    var af, power;
    af = authFunctions.c || dummyAuthFunction;
    power = req.user ? req.user[pf] : me.settings.defaultPower;
    return af(req, req.user, power, function(err) {
      var obj;
      if (err) {
        return res.send(401, err.message);
      } else {
        obj = h.unwrap(req.body);
        if (apiFunctions.c != null) {
          return apiFunctions.c(req, res, model, obj, function(err, result) {
            if (err) {
              return res.send(500, err.message);
            } else {
              return res.send(result.code, h.wrap(result.data, name));
            }
          });
        } else {
          obj = new model(obj);
          if (manipulateFunctions.c != null) {
            return manipulateFunctions.c(obj, req.user, function(err, obj) {
              if (err) {
                return res.send(500, err.message);
              } else {
                return obj.save(function(err, result) {
                  if (err) {
                    return res.send(500, err.message);
                  } else {
                    return res.send(201, h.wrap(result, name));
                  }
                });
              }
            });
          } else {
            return obj.save(function(err, result) {
              if (err) {
                return res.send(500, err.message);
              } else {
                return res.send(201, h.wrap(result, name));
              }
            });
          }
        }
      }
    });
  });
  app.get(url, function(req, res) {
    var af, power;
    af = authFunctions.ra || dummyAuthFunction;
    power = req.user ? req.user[pf] : me.settings.defaultPower;
    return af(req, req.user, power, function(err) {
      if (err) {
        return res.send(401, err.message);
      } else {
        if (apiFunctions.ra != null) {
          return apiFunctions.ra(req, res, model, null, function(err, result) {
            if (err) {
              return res.send(500, err.message);
            } else {
              return res.send(result.code, h.wrap(result.data, cname));
            }
          });
        } else {
          return model.find({}, function(err, result) {
            if (err) {
              return res.send(500, err.message);
            } else if (manipulateFunctions.ra != null) {
              return manipulateFunctions.ra(result, req.user, function(err, result) {
                if (err) {
                  return res.send(500, err.message);
                } else {
                  return res.send(200, h.wrap(result, cname));
                }
              });
            } else {
              return res.send(200, h.wrap(result, cname));
            }
          });
        }
      }
    });
  });
  app.get(url + '/:id', function(req, res) {
    var af, power;
    af = authFunctions.ro || dummyAuthFunction;
    power = req.user ? req.user[pf] : me.settings.defaultPower;
    return af(req, req.user, power, function(err) {
      var id;
      if (err) {
        return res.send(401, err.message);
      } else {
        id = req.params.id;
        if (apiFunctions.ro != null) {
          return apiFunctions.ro(req, res, model, {
            id: id
          }, function(err, result) {
            if (err) {
              return res.send(500, err.message);
            } else {
              return res.send(result.code, h.wrap(result.data, name));
            }
          });
        } else {
          return model.findById(id, function(err, result) {
            if (err) {
              return res.send(500, err.message);
            } else if (manipulateFunctions.ro != null) {
              return manipulateFunctions.ro(result, req.user, function(err, result) {
                if (err) {
                  return res.send(500, err.message);
                } else {
                  return res.send(200, h.wrap(result, name));
                }
              });
            } else {
              return res.send(200, h.wrap(result, name));
            }
          });
        }
      }
    });
  });
  app.put(url + '/:id', function(req, res) {
    var af, power;
    af = authFunctions.u || dummyAuthFunction;
    power = req.user ? req.user[pf] : me.settings.defaultPower;
    return af(req, req.user, power, function(err) {
      var id, obj;
      if (err) {
        return res.send(401, err.message);
      } else {
        id = req.params.id;
        obj = h.unwrap(req.body);
        if (apiFunctions.u != null) {
          return apiFunctions.u(req, res, model, obj, function(err, result) {
            if (err) {
              return res.send(500, err.message);
            } else {
              return res.send(result.code, h.wrap(result.data, name));
            }
          });
        } else {
          if (manipulateFunctions.u != null) {
            return manipulateFunctions.u(obj, req.user, function(err, obj) {
              if (err) {
                return res.send(500, err.message);
              } else {
                return model.findByIdAndUpdate(id, obj, function(err, result) {
                  if (err) {
                    return res.send(500, err.message);
                  } else {
                    return res.send(200, h.wrap(result, name));
                  }
                });
              }
            });
          } else {
            return model.findByIdAndUpdate(id, obj, function(err, result) {
              if (err) {
                return res.send(500, err.message);
              } else {
                return res.send(200, h.wrap(result, name));
              }
            });
          }
        }
      }
    });
  });
  return app["delete"](url + '/:id', function(req, res) {
    var af, power;
    af = authFunctions.d || dummyAuthFunction;
    power = req.user ? req.user[pf] : me.settings.defaultPower;
    return af(req, req.user, power, function(err) {
      var id;
      if (err) {
        return res.send(401, err.message);
      } else {
        id = req.params.id;
        if (apiFunctions.d != null) {
          return apiFunctions.d(req, res, model, {
            id: id
          }, function(err, result) {
            if (err) {
              return res.send(500, err.message);
            } else {
              return res.send(204, h.wrap(result.data, name));
            }
          });
        } else {
          return model.findById(id, function(err, result) {
            if (err) {
              return res.send(500, err.message);
            } else if (result == null) {
              return res.send(500, 'No matching item to delete');
            } else {
              if (manipulateFunctions.d != null) {
                return manipulateFunctions.d(result, req.user, function(err, result) {
                  if (err) {
                    return res.send(500, err.message);
                  } else {
                    return result.remove(function(err, result) {
                      if (err) {
                        return res.send(500, err.message);
                      } else {
                        return res.send(204);
                      }
                    });
                  }
                });
              } else {
                return result.remove(function(err, result) {
                  if (err) {
                    return res.send(500, err.message);
                  } else {
                    return res.send(204);
                  }
                });
              }
            }
          });
        }
      }
    });
  });
};

api = module.exports = {
  middleware: function(req, res, next) {
    if (me.settings.namespace != null) {
      if (req.path.toLowerCase().indexOf(me.settings.namespace.toLowerCase()) >= 0) {
        res.set('Last-Modified', (new Date()).toUTCString());
      }
    }
    return next();
  },
  bind: function(app) {
    var cname, model, models, name, root, url;
    root = '/' + (me.settings.namespace || '');
    models = mongoose.models;
    for (name in models) {
      model = models[name];
      cname = utils.toCollectionName(name);
      url = root + '/' + cname;
      crud(app, url, name);
    }
  }
};
